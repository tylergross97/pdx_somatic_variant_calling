nextflow_process {
    name "Test Process BAMCMP"
    script "modules/local/bamcmp.nf"
    process "BAMCMP"
    
    test("Process runs successfully") {
        setup {
            run("SORT_BAM") {
                script "modules/local/sort_bam.nf"
                process {
                    """
                    input[0] = Channel
                        .fromPath("${projectDir}/tests/data/alignment_output/*.bam")
                        .map { bam_path ->
                            def sample_id = bam_path.getSimpleName()
                            tuple(sample_id, bam_path)
                        }
                    """
                }
            }
        }
        
        when {
            process {
                """
                input[0] = SORT_BAM.out.sorted_bam
                    .map { sample_id, bam ->
                        def species = bam.name.contains("human") ? "human" : "mouse"
                        tuple(sample_id, species, bam)
                    }
                    .groupTuple(by: [0, 1])
                    .map { sample_id, species, bams -> 
                        tuple(sample_id, species, bams[0])
                    }
                    .branch {
                        human: it[1] == "human"
                        mouse: it[1] == "mouse"
                    }
                    .set { sorted_bams }
                
                // Create the paired input for BAMCMP
                input[0] = sorted_bams.human
                    .join(sorted_bams.mouse, by: 0)
                    .map { sample_id, human_species, human_bam, mouse_species, mouse_bam ->
                        tuple(sample_id, human_bam, mouse_bam)
                    }
                """
            }
        }
        
        then {
            def pdx70_human_better = process.out.human_better.get(0)
            println("PDX70 Human Better BAM: ${pdx70_human_better}")
            def pdx70_mouse_better = process.out.mouse_better.get(0)
            println("PDX70 Mouse Better BAM: ${pdx70_mouse_better}")
            def pdx90_human_better = process.out.human_better.get(1)
            println("PDX90 Human Better BAM: ${pdx90_human_better}")
            def pdx90_mouse_better = process.out.mouse_better.get(1)
            println("PDX90 Mouse Better BAM: ${pdx90_mouse_better}")

            def pdx70_human_stats = bam(pdx70_human_better[1]).getStatistics().toString()
            println("PDX70 Human Stats: ${pdx70_human_stats}")
            def pdx70_mouse_stats = bam(pdx70_mouse_better[1]).getStatistics().toString()
            println("PDX70 Mouse Stats: ${pdx70_mouse_stats}")
            def pdx90_human_stats = bam(pdx90_human_better[1]).getStatistics().toString()
            println("PDX90 Human Stats: ${pdx90_human_stats}")
            def pdx90_mouse_stats = bam(pdx90_mouse_better[1]).getStatistics().toString()
            println("PDX90 Mouse Stats: ${pdx90_mouse_stats}")

            def pdx70_human_reads = (pdx70_human_stats =~ /readCount:(\d+)/)[0][1] as int
            def pdx70_mouse_reads = (pdx70_mouse_stats =~ /readCount:(\d+)/)[0][1] as int
            def pdx90_human_reads = (pdx90_human_stats =~ /readCount:(\d+)/)[0][1] as int
            def pdx90_mouse_reads = (pdx90_mouse_stats =~ /readCount:(\d+)/)[0][1] as int

            def pdx70_human_prop = pdx70_human_reads / (pdx70_human_reads + pdx70_mouse_reads)
            def pdx90_human_prop = pdx90_human_reads / (pdx90_human_reads + pdx90_mouse_reads)

            assert pdx90_human_prop > pdx70_human_prop : "Expected pdx90 to have a higher human read proportion than pdx70"
            assert process.success
        }
    }
}